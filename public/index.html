<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Online Board</title>

<style>
body {
  margin: 0;
  font-family: Inter, system-ui, Arial;
  background: radial-gradient(circle at top, #1e1e2f, #0f0f18);
  color: #fff;
  display: flex;
  flex-direction: column;
  align-items: center;
}

#login {
  position: fixed;
  inset: 0;
  background: #000a;
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
}

#loginBox {
  background: rgba(255,255,255,0.1);
  backdrop-filter: blur(10px);
  padding: 30px;
  border-radius: 16px;
}

#login input {
  padding: 10px;
  width: 200px;
}

#controls {
  margin-top: 10px;
  padding: 12px 18px;
  display: flex;
  gap: 10px;
  background: rgba(255,255,255,0.08);
  backdrop-filter: blur(10px);
  border-radius: 16px;
}

.color, .eraser, .size {
  width: 26px;
  height: 26px;
  border-radius: 50%;
  cursor: pointer;
  border: 2px solid #aaa;
}

.active {
  box-shadow: 0 0 0 3px #fff;
}

#board {
  position: relative;
  margin-top: 10px;
}

canvas {
  position: absolute;
  left: 0;
  top: 0;
  background: white;
  border-radius: 16px;
}

#chat {
  margin-top: 10px;
  width: 90%;
  max-width: 900px;
  height: 200px;
  background: rgba(255,255,255,0.08);
  backdrop-filter: blur(10px);
  border-radius: 16px;
  padding: 10px;
  display: flex;
  flex-direction: column;
}

#messages {
  flex: 1;
  overflow-y: auto;
}

#chat input {
  padding: 10px;
  border-radius: 10px;
  border: none;
}
</style>
</head>
<body>

<div id="login">
  <div id="loginBox">
    <h3>Введите ник</h3>
    <input id="nick">
    <button onclick="join()">Войти</button>
  </div>
</div>

<div id="controls">
  <div class="color active" data-c="#000" style="background:#000"></div>
  <div class="color" data-c="#f00" style="background:#f00"></div>
  <div class="color" data-c="#0f0" style="background:#0f0"></div>
  <div class="color" data-c="#00f" style="background:#00f"></div>
  <div class="eraser" title="Ластик"></div>
  <div class="size active" data-s="2"></div>
  <div class="size" data-s="4"></div>
  <div class="size" data-s="6"></div>
  <div class="size" data-s="8"></div>
</div>

<div id="board">
  <canvas id="draw"></canvas>
  <canvas id="cursor"></canvas>
</div>

<div id="chat">
  <div id="messages"></div>
  <input id="chatInput" placeholder="Сообщение">
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();

function join(){
  const n = nick.value.trim();
  if(!n) return;
  socket.emit('join', n);
  login.style.display = 'none';
}

// CANVAS SETUP
const drawC = draw.getContext('2d');
const cursorC = cursor.getContext('2d');

function resize(){
  const w = window.innerWidth - 40;
  const h = window.innerHeight - 420;
  draw.width = cursor.width = w;
  draw.height = cursor.height = h;
}
resize(); window.onresize = resize;

let color = '#000';
let size = 2;
let drawing = false;
let lx, ly;

// TOOLS
document.querySelectorAll('.color').forEach(b=>{
  b.onclick=()=>{
    color=b.dataset.c;
    document.querySelectorAll('.active').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
  };
});
document.querySelector('.eraser').onclick=()=>color='#fff';
document.querySelectorAll('.size').forEach(b=>{
  b.onclick=()=>{
    size=+b.dataset.s;
    document.querySelectorAll('.size').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
  };
});

// DRAW
function pos(e){
  const r = draw.getBoundingClientRect();
  return {x:e.clientX-r.left,y:e.clientY-r.top};
}

draw.onmousedown=e=>{
  drawing=true;
  ({x:lx,y:ly}=pos(e));
};

draw.onmousemove=e=>{
  const p=pos(e);
  socket.emit('cursor',{...p,color});
  if(!drawing) return;
  line(lx,ly,p.x,p.y,color,size,true);
  lx=p.x; ly=p.y;
};

draw.onmouseup=()=>drawing=false;

function line(x0,y0,x1,y1,c,s,emit){
  drawC.beginPath();
  drawC.moveTo(x0,y0);
  drawC.lineTo(x1,y1);
  drawC.strokeStyle=c;
  drawC.lineWidth=s;
  drawC.lineCap='round';
  drawC.stroke();
  if(emit) socket.emit('drawing',{x0,y0,x1,y1,color:c,width:s});
}

socket.on('drawing',d=>line(d.x0,d.y0,d.x1,d.y1,d.color,d.width));
socket.on('drawingHistory',h=>h.forEach(d=>line(d.x0,d.y0,d.x1,d.y1,d.color,d.width)));

// CURSORS (SMOOTH)
const cursors={};
function lerp(a,b,t){return a+(b-a)*t;}

socket.on('cursor',d=>{
  cursors[d.id] ??= {...d,tx:d.x,ty:d.y};
  cursors[d.id].tx=d.x;
  cursors[d.id].ty=d.y;
});
socket.on('removeCursor',id=>delete cursors[id]);

function renderCursors(){
  cursorC.clearRect(0,0,cursor.width,cursor.height);
  Object.values(cursors).forEach(c=>{
    c.x=lerp(c.x,c.tx,0.2);
    c.y=lerp(c.y,c.ty,0.2);
    cursorC.fillStyle=c.color;
    cursorC.beginPath();
    cursorC.arc(c.x,c.y,4,0,Math.PI*2);
    cursorC.fill();
    cursorC.fillStyle='#000';
    cursorC.fillText(c.nick,c.x+6,c.y-6);
  });
  requestAnimationFrame(renderCursors);
}
renderCursors();

// CHAT
const msgs = messages;
let last=0;

chatInput.onkeydown=e=>{
  if(e.key==='Enter' && Date.now()-last>1000){
    socket.emit('chatMessage',chatInput.value);
    chatInput.value='';
    last=Date.now();
  }
};

socket.on('chatHistory',h=>h.forEach(add));
socket.on('chatMessage',add);
socket.on('systemMessage',t=>add({nick:'*',text:t}));

function add(m){
  const d=document.createElement('div');
  d.textContent=`[${m.nick}] ${m.text}`;
  msgs.appendChild(d);
  msgs.scrollTop=msgs.scrollHeight;
}
</script>
</body>
</html>
