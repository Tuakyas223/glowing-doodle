<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Онлайн Холст</title>

<style>
body {
  margin: 0;
  font-family: Arial;
  background: #f0f0f0;
  display: flex;
  flex-direction: column;
  align-items: center;
}

#login {
  position: fixed;
  inset: 0;
  background: #000000cc;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index: 1000;
}

#login input, #login button {
  padding: 10px;
  margin-top: 10px;
  font-size: 16px;
}

#controls {
  margin-top: 10px;
  background: #fff;
  padding: 10px;
  border-radius: 10px;
  display: flex;
  gap: 10px;
}

.color-btn, .eraser-btn {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  cursor: pointer;
  border: 2px solid #ccc;
}

.selected {
  border: 2px solid black;
}

.line-btn {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  border: 2px solid #666;
  cursor: pointer;
  display: flex;
  justify-content: center;
  align-items: center;
}

canvas {
  margin-top: 10px;
  background: white;
  border-radius: 10px;
  border: 2px solid #333;
}

#chat {
  margin-top: 10px;
  width: 90%;
  max-width: 800px;
  background: white;
  border-radius: 10px;
  padding: 10px;
  display: flex;
  flex-direction: column;
  height: 200px;
}

#messages {
  flex: 1;
  overflow-y: auto;
}

</style>
</head>
<body>

<!-- LOGIN -->
<div id="login">
  <h2 style="color:white">Введите ник</h2>
  <input id="nickname">
  <button id="enterBtn">Войти</button>
</div>

<!-- CONTROLS -->
<div id="controls">
  <div class="color-btn selected" data-color="#000" style="background:#000"></div>
  <div class="color-btn" data-color="#f00" style="background:#f00"></div>
  <div class="color-btn" data-color="#0f0" style="background:#0f0"></div>
  <div class="color-btn" data-color="#00f" style="background:#00f"></div>
  <div class="eraser-btn" title="Ластик" style="background:#fff"></div>

  <div class="line-btn selected" data-width="2"><div style="height:2px;width:12px;background:#000"></div></div>
  <div class="line-btn" data-width="4"><div style="height:4px;width:12px;background:#000"></div></div>
  <div class="line-btn" data-width="6"><div style="height:6px;width:12px;background:#000"></div></div>
  <div class="line-btn" data-width="8"><div style="height:8px;width:12px;background:#000"></div></div>
</div>

<canvas id="canvas"></canvas>

<!-- CHAT -->
<div id="chat">
  <div id="messages"></div>
  <input id="chatInput" placeholder="Сообщение">
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();
let nickname = null;

// LOGIN
document.getElementById('enterBtn').onclick = () => {
  nickname = document.getElementById('nickname').value.trim();
  if (!nickname) return;
  socket.emit('join', nickname);
  document.getElementById('login').style.display = 'none';
};

// CANVAS
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

function resize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight - 350;
}
resize();
window.onresize = resize;

let drawing = false;
let lastX, lastY;
let color = '#000';
let width = 2;

// TOOLS
document.querySelectorAll('.color-btn').forEach(b => {
  b.onclick = () => {
    color = b.dataset.color;
    document.querySelectorAll('.selected').forEach(x => x.classList.remove('selected'));
    b.classList.add('selected');
  };
});

document.querySelector('.eraser-btn').onclick = () => {
  color = '#fff';
};

document.querySelectorAll('.line-btn').forEach(b => {
  b.onclick = () => {
    width = +b.dataset.width;
    document.querySelectorAll('.line-btn').forEach(x => x.classList.remove('selected'));
    b.classList.add('selected');
  };
});

// DRAW
function pos(e) {
  const r = canvas.getBoundingClientRect();
  return { x: e.clientX - r.left, y: e.clientY - r.top };
}

canvas.onmousedown = e => {
  drawing = true;
  ({x:lastX,y:lastY} = pos(e));
};

canvas.onmousemove = e => {
  const p = pos(e);
  socket.emit('cursor', p);
  if (!drawing) return;
  draw(lastX, lastY, p.x, p.y, color, width, true);
  lastX = p.x;
  lastY = p.y;
};

canvas.onmouseup = () => drawing = false;

function draw(x0,y0,x1,y1,c,w,emit){
  ctx.beginPath();
  ctx.moveTo(x0,y0);
  ctx.lineTo(x1,y1);
  ctx.strokeStyle=c;
  ctx.lineWidth=w;
  ctx.lineCap='round';
  ctx.stroke();
  if(emit) socket.emit('drawing',{x0,y0,x1,y1,color:c,width:w});
}

// SOCKET
socket.on('drawing', d => draw(d.x0,d.y0,d.x1,d.y1,d.color,d.width));
socket.on('drawingHistory', h => h.forEach(d => draw(d.x0,d.y0,d.x1,d.y1,d.color,d.width)));

// CURSORS
const cursors = {};
socket.on('cursor', d => cursors[d.id] = d);

setInterval(() => {
  ctx.clearRect(0,0,0,0);
  Object.values(cursors).forEach(c => {
    ctx.fillStyle='red';
    ctx.fillRect(c.x,c.y,4,4);
    ctx.fillText(c.nick,c.x+6,c.y);
  });
},50);

// CHAT
const messages = document.getElementById('messages');
const input = document.getElementById('chatInput');
let lastSend = 0;

input.onkeydown = e => {
  if(e.key==='Enter'){
    if(Date.now()-lastSend<1000) return;
    socket.emit('chatMessage', input.value);
    input.value='';
    lastSend=Date.now();
  }
};

socket.on('chatHistory', h => h.forEach(addMsg));
socket.on('chatMessage', addMsg);
socket.on('systemMessage', t => addMsg({nick:'*',text:t}));

function addMsg(m){
  const d=document.createElement('div');
  d.textContent=`[${m.nick}] ${m.text}`;
  messages.appendChild(d);
  messages.scrollTop=messages.scrollHeight;
}
</script>
</body>
</html>
