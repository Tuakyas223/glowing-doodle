<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Online Board</title>

<style>
body {
  margin: 0;
  font-family: system-ui, Arial;
  background: radial-gradient(circle at top, #1e1e2f, #0f0f18);
  color: #fff;
  display: flex;
  flex-direction: column;
  align-items: center;
}

#login {
  position: fixed;
  inset: 0;
  background: #000a;
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 10;
}

#loginBox {
  background: rgba(255,255,255,.1);
  backdrop-filter: blur(10px);
  padding: 20px;
  border-radius: 14px;
}

#controls {
  margin-top: 10px;
  padding: 10px 16px;
  display: flex;
  gap: 8px;
  background: rgba(255,255,255,.1);
  backdrop-filter: blur(10px);
  border-radius: 14px;
}

.color,.size,.eraser {
  width: 26px;
  height: 26px;
  border-radius: 50%;
  cursor: pointer;
  border: 2px solid #aaa;
}

.active { box-shadow: 0 0 0 3px #fff; }

#board {
  position: relative;
  width: 90vw;
  max-width: 1200px;
  height: 60vh;
  margin-top: 10px;
  flex-shrink: 0;
}

canvas {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  background: white;
  border-radius: 16px;
}

#chat {
  margin-top: 10px;
  width: 90vw;
  max-width: 1200px;
  height: 200px;
  background: rgba(255,255,255,.1);
  backdrop-filter: blur(10px);
  border-radius: 14px;
  padding: 10px;
  display: flex;
  flex-direction: column;
}

#messages {
  flex: 1;
  overflow-y: auto;
  font-size: 14px;
}

#chat input {
  margin-top: 6px;
  padding: 8px;
  border-radius: 8px;
  border: none;
}
</style>
</head>
<body>

<div id="login">
  <div id="loginBox">
    <h3>Ник</h3>
    <input id="nick">
    <button onclick="join()">Войти</button>
  </div>
</div>

<div id="controls">
  <div class="color active" data-c="#000" style="background:#000"></div>
  <div class="color" data-c="#f00" style="background:#f00"></div>
  <div class="color" data-c="#0f0" style="background:#0f0"></div>
  <div class="color" data-c="#00f" style="background:#00f"></div>
  <div class="eraser"></div>
  <div class="size active" data-s="2"></div>
  <div class="size" data-s="4"></div>
  <div class="size" data-s="6"></div>
  <div class="size" data-s="8"></div>
</div>

<div id="board">
  <canvas id="draw"></canvas>
  <canvas id="cursor"></canvas>
</div>

<div id="chat">
  <div id="messages"></div>
  <input id="chatInput" placeholder="Сообщение">
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();

function join(){
  if(!nick.value.trim()) return;
  socket.emit('join', nick.value.trim());
  login.style.display='none';
}

const drawCtx = draw.getContext('2d');
const cursorCtx = cursor.getContext('2d');

function resize(){
  const r = board.getBoundingClientRect();
  draw.width = cursor.width = r.width;
  draw.height = cursor.height = r.height;
}
resize(); window.addEventListener('resize', resize);

let color='#000', size=2, drawing=false, lx=0, ly=0;

// tools
document.querySelectorAll('.color').forEach(b=>{
  b.onclick=()=>{ color=b.dataset.c; setActive(b,'.color'); };
});
document.querySelector('.eraser').onclick=()=>color='#fff';
document.querySelectorAll('.size').forEach(b=>{
  b.onclick=()=>{ size=+b.dataset.s; setActive(b,'.size'); };
});
function setActive(el,sel){
  document.querySelectorAll(sel).forEach(x=>x.classList.remove('active'));
  el.classList.add('active');
}

// mouse
function pos(e){
  const r=draw.getBoundingClientRect();
  return {x:e.clientX-r.left,y:e.clientY-r.top};
}

draw.onmousedown=e=>{ drawing=true; ({x:lx,y:ly}=pos(e)); };
draw.onmouseup=()=>drawing=false;

draw.onmousemove=e=>{
  const p=pos(e);
  socket.emit('cursor',{x:p.x,y:p.y,color});
  if(!drawing) return;
  line(lx,ly,p.x,p.y,color,size,true);
  lx=p.x; ly=p.y;
};

function line(x0,y0,x1,y1,c,s,emit){
  drawCtx.beginPath();
  drawCtx.moveTo(x0,y0);
  drawCtx.lineTo(x1,y1);
  drawCtx.strokeStyle=c;
  drawCtx.lineWidth=s;
  drawCtx.lineCap='round';
  drawCtx.stroke();
  if(emit) socket.emit('draw',{x0,y0,x1,y1,color:c,width:s});
}

socket.on('draw',d=>line(d.x0,d.y0,d.x1,d.y1,d.color,d.width));
socket.on('drawHistory',h=>h.forEach(d=>line(d.x0,d.y0,d.x1,d.y1,d.color,d.width)));

// cursors smooth
const cursors={};
const lerp=(a,b,t)=>a+(b-a)*t;

socket.on('cursor',d=>{
  cursors[d.id] ??= {...d,tx:d.x,ty:d.y};
  cursors[d.id].tx=d.x;
  cursors[d.id].ty=d.y;
});
socket.on('removeCursor',id=>delete cursors[id]);

(function render(){
  cursorCtx.clearRect(0,0,cursor.width,cursor.height);
  Object.values(cursors).forEach(c=>{
    c.x=lerp(c.x,c.tx,0.2);
    c.y=lerp(c.y,c.ty,0.2);
    cursorCtx.fillStyle=c.color;
    cursorCtx.beginPath();
    cursorCtx.arc(c.x,c.y,4,0,Math.PI*2);
    cursorCtx.fill();
    cursorCtx.fillStyle='#000';
    cursorCtx.fillText(c.nick,c.x+6,c.y-6);
  });
  requestAnimationFrame(render);
})();

// chat
chatInput.onkeydown=e=>{
  if(e.key==='Enter' && chatInput.value.trim()){
    socket.emit('chat',chatInput.value.trim());
    chatInput.value='';
  }
};

socket.on('chatHistory',h=>h.forEach(addMsg));
socket.on('chat',addMsg);
socket.on('system',t=>addMsg({nick:'*',text:t}));

function addMsg(m){
  const d=document.createElement('div');
  d.textContent=`[${m.nick}] ${m.text}`;
  messages.appendChild(d);
  messages.scrollTop=messages.scrollHeight;
}
</script>
</body>
</html>
